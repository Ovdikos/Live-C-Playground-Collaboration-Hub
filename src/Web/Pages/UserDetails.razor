@page "/admin/user/{Username}"
@inject HttpClient Http
@inject UserState UserState
@inject NavigationManager Nav
@inject IJSRuntime Js

@code {
    [Parameter] public string Username { get; set; } = "";

    private UserDetailsDto? user;
    private bool isLoading = true;
    private bool notFound = false;

    private bool showPassword = false;
    private bool showId = false;
    private string passwordInputType => showPassword ? "text" : "password";

    protected override async Task OnInitializedAsync()
    {
        if (!UserState.IsAuthenticated || UserState.User?.IsAdmin != true)
        {
            Nav.NavigateTo("/");
            return;
        }

        Http.DefaultRequestHeaders.Authorization =
            new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", UserState.Token);

        try
        {
            user = await Http.GetFromJsonAsync<UserDetailsDto>($"/api/admin/user/{Username}");
            notFound = user == null;
        }
        catch
        {
            notFound = true;
        }
        isLoading = false;
    }

    private async Task ToggleBlockUser()
    {
        if (user == null) return;
        var response = await Http.PostAsJsonAsync("/api/admin/user/block",
            new { UserId = user.Id, Block = !user.IsBlocked });
        if (response.IsSuccessStatusCode)
        {
            user.IsBlocked = !user.IsBlocked;
            StateHasChanged();
        }
    }

    private async Task DeleteUser()
    {
        if (user == null) return;
        if (!await Js.InvokeAsync<bool>("confirm", "Are you sure you want to delete this user?"))
            return;

        var response = await Http.DeleteAsync($"/api/admin/user/{user.Id}");
        if (response.IsSuccessStatusCode)
        {
            Nav.NavigateTo("/admin");
        }
    }
}

@if (isLoading)
{
    <div>Loading user data...</div>
}
else if (notFound)
{
    <div>User not found.</div>
}
else
{
    <div class="user-details-container">
        <div style="display:flex; justify-content:flex-end; gap:18px;">
            <button class="btn btn-warning" @onclick="ToggleBlockUser">
                @(user!.IsBlocked ? "Unblock" : "Block")
            </button>
            <button class="btn btn-danger" @onclick="DeleteUser">
                Delete
            </button>
        </div>
        <h2><b>User: @user!.Username</b></h2>
        <p>
            <span class="hint-on-hover">
                <b>ID:</b> <span class="masked">@user.Id.ToString()</span>
                <span class="tooltip">@user.Id.ToString()</span>
            </span>
        </p>
        <p>Email: @user.Email</p>
        <p>Created At: @user.CreatedAt.ToString("yyyy-MM-dd HH:mm")</p>
        <p>Is Admin: @(user.IsAdmin ? "Yes" : "No")</p>
        <p>
            <span class="hint-on-hover">
                <b>Password:</b> <span class="masked">•••••••••••</span>
                <span class="tooltip">@user.PasswordHash</span>
            </span>
        </p>
        @if (user.IsBlocked && !string.IsNullOrEmpty(user.BlockedByAdminEmail))
        {
            <p style="color:#d00;font-weight:600;">
                Account is blocked. Contact admin: @user.BlockedByAdminEmail
            </p>
        }

        <h4>Snippets</h4>
        @if (user.CodeSnippets.Any())
        {
            <ul>
                @foreach (var snip in user.CodeSnippets)
                {
                    <li>
                        <b>@snip.Title</b> (@snip.Id)<br />
                        Content: <span style="font-family:monospace">@snip.Content</span><br />
                        Created: @snip.CreatedAt.ToString("yyyy-MM-dd HH:mm")<br />
                        Updated: @(snip.UpdatedAt?.ToString("yyyy-MM-dd HH:mm") ?? "—")<br />
                        Public: @(snip.IsPublic ? "Yes" : "No")
                    </li>
                }
            </ul>
        }
        else
        {
            <div>No snippets found.</div>
        }

        <h4>Sessions</h4>
        @if (user.CollabSessions.Any())
        {
            <ul>
                @foreach (var sess in user.CollabSessions)
                {
                    <li>
                        <b>@sess.Name</b> (@sess.Id)<br />
                        Snippet: @sess.CodeSnippetTitle<br />
                        Created: @sess.CreatedAt.ToString("yyyy-MM-dd HH:mm")<br />
                        Expires: @(sess.ExpiresAt?.ToString("yyyy-MM-dd HH:mm") ?? "—")<br />
                        Edited: @(sess.EditedAt?.ToString("yyyy-MM-dd HH:mm") ?? "—")<br />
                        Active: @(sess.IsActive ? "Yes" : "No")<br />
                        Join Code: @sess.JoinCode<br />
                        Owner: @sess.Owner
                    </li>
                }
            </ul>
        }
        else
        {
            <div>No sessions found.</div>
        }

        <h4>Owned Sessions</h4>
        @if (user.OwnedSessions.Any())
        {
            <ul>
                @foreach (var sess in user.OwnedSessions)
                {
                    <li>
                        <b>@sess.Name</b> (@sess.Id)<br />
                        Snippet: @sess.CodeSnippetTitle<br />
                        Created: @sess.CreatedAt.ToString("yyyy-MM-dd HH:mm")<br />
                        Expires: @(sess.ExpiresAt?.ToString("yyyy-MM-dd HH:mm") ?? "—")<br />
                        Edited: @(sess.EditedAt?.ToString("yyyy-MM-dd HH:mm") ?? "—")<br />
                        Active: @(sess.IsActive ? "Yes" : "No")<br />
                        Join Code: @sess.JoinCode<br />
                        Owner: @sess.Owner
                    </li>
                }
            </ul>
        }
        else
        {
            <div>No owned sessions found.</div>
        }
    </div>
}
