@page "/register"
@using Application.DTOs.LoginRegisterDtos
@using Application.DTOs.UserDtos
@using Web.AuthService
@inject HttpClient Http
@inject NavigationManager Nav
@inject UserState UserState
@inject IJSRuntime Js

<EditForm Model="_register" OnValidSubmit="HandleRegister" FormName="registerForm">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label for="username">Login</label>
        <InputText id="username" class="form-control" @bind-Value="_register.Username" />
    </div>
    <div class="mb-3">
        <label for="password">Password</label>
        <InputText id="password" type="password" class="form-control" @bind-Value="_register.Password" />
    </div>
    <div class="mb-3">
        <label for="email">Email</label>
        <InputText id="email" type="email" class="form-control" @bind-Value="_register.Email" />
    </div>
    <div class="mb-3">
        <label>Avatar (optional)</label>
        <InputFile @ref="_fileInputRef" OnChange="OnInputFileChange" accept="image/png, image/jpeg" />
        @if (!string.IsNullOrEmpty(_avatarPreview))
        {
            <img src="@_avatarPreview" style="max-width:150px;max-height:150px;border-radius:50%;margin-top:8px;" />
        }
    </div>
    <button class="btn btn-success w-100" type="submit">Register</button>
    <div class="text-center mt-3">
        <a href="/login">Already have an account? Login</a>
    </div>
</EditForm>

<CropperModal Show="@_showCropper"
              ImageUrl="@_cropperImageUrl"
              OnCrop="@OnAvatarCropped"
              OnClose="@CloseCropperModal" />

@if (!string.IsNullOrEmpty(_error))
{
    <div class="alert alert-danger">@_error</div>
}

@code {
    private RegisterUserDto _register = new();
    private string? _error;

    private IBrowserFile? _avatarFile;
    private string? _avatarPreview;
    private string? _avatarBase64;
    private bool _showCropper = false;
    private string? _cropperImageUrl;
    private InputFile _fileInputRef; 

    private async Task OnInputFileChange(InputFileChangeEventArgs e)
    {
        _avatarFile = e.File;
        var buffer = new byte[_avatarFile.Size];
        await _avatarFile.OpenReadStream(5 * 1024 * 1024).ReadAsync(buffer);
        _cropperImageUrl = $"data:{_avatarFile.ContentType};base64,{Convert.ToBase64String(buffer)}";
        _showCropper = true;
    }

    private async Task OnAvatarCropped(string? croppedBase64)
    {
        _avatarPreview = croppedBase64;
        _avatarBase64 = croppedBase64;
        _showCropper = false;
        StateHasChanged();
    }

    private async Task CloseCropperModal()
    {
        _showCropper = false;
        await Js.InvokeVoidAsync("focusElement", _fileInputRef);
        StateHasChanged();
    }

    private async Task HandleRegister()
    {
        _error = null;
        if (string.IsNullOrWhiteSpace(_register.Username) ||
            string.IsNullOrWhiteSpace(_register.Password) ||
            string.IsNullOrWhiteSpace(_register.Email))
        {
            _error = "Please fill in all required fields!";
            return;
        }

        var content = new MultipartFormDataContent();
        content.Add(new StringContent(_register.Username), "Login");
        content.Add(new StringContent(_register.Password), "Password");
        content.Add(new StringContent(_register.Email), "Email");

        if (!string.IsNullOrEmpty(_avatarBase64))
        {
            var base64Data = _avatarBase64.Substring(_avatarBase64.IndexOf(",") + 1);
            var bytes = Convert.FromBase64String(base64Data);
            var byteContent = new ByteArrayContent(bytes);
            byteContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("image/png");
            content.Add(byteContent, "Avatar", "avatar.png");
        }

        var response = await Http.PostAsync("/api/auth/register", content);

        if (!response.IsSuccessStatusCode)
        {
            _error = "Username or email are already taken.";
            return;
        }

        var result = await response.Content.ReadFromJsonAsync<AuthResult>();
        if (result is not null)
        {
            await UserState.SetAuthAsync(result.Token, result.User);
            Nav.NavigateTo("/");
        }
    }

    public class AuthResult
    {
        public string Token { get; set; } = default!;
        public UserDto User { get; set; } = default!;
    }
}
